<html data-cast-api-enabled="true">
<head>
	<title>sender</title>
	<style type="text/css">
		body {
			text-align: center;
		}
		h1 {
			font-size: 96px;
		}
	</style>

	  <script src="globals.js"></script>

	  <script text="type/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	  <!-- https://github.com/LearnBoost/Socket.IO/wiki/How-do-I-serve-the-client -->
	  <script src="http://localhost:9999/socket.io/socket.io.js"></script>

	  <script>


	    var socket;

	    try {
    		socket = io.connect(socketio_server);
	    }

	    catch (e){
		console.log(e);
	    }

	    console.log(socket);

	    if (socket){

	    	socket.on('pew pew', function(data){

				var dt = new Date();
				var time = dt.getHours() + ':' + dt.getMinutes() + ':' + dt.getSeconds();

				var body = data['message'] + ' ' + time;
				send_message_to_cc({'type': 'message', 'body': body});
		});

	    	socket.on('pew pew pew', function(data){

				var body = data['message'];
				send_message_to_cc({'type': 'url', 'body': body});
		});

	    }
	    
		var msg_rcvd_callback=function(data){
			console.log("sender callback");
			console.log(data);
			send_message_to_cc(data.cmd);
		};

		var cast_api;
		var cv_activity;

		var cast_app_id = chromecast_appid;

		if (window.cast && window.cast.isAvailable) {
		  	// Cast is known to be available
			console.log("cast api available");
			initializeApi();
		} else {
			console.log("cast api not available, adding listener for hello message");
			// Wait for API to post a message to us
			window.addEventListener("message", function(event) {
				if (event.source == window && event.data && 
					event.data.source == "CastApi" &&
					event.data.event == "Hello") {
					initialize_cast_api();
				}
		  });
		};

		initialize_cast_api = function() {
			cast_api = new cast.Api();
			cast_api.addReceiverListener(cast_app_id, on_receiver_list);
		};

		on_receiver_list = function(receivers) {
			if(receivers.length == 0) {
				return;
			}
			for (var i=0;i<receivers.length;i++) {
				console.log(receivers[i]);
				console.log("status...");
				console.log(cast.ActivityStatus(cast_app_id));
				var launch_request = new cast.LaunchRequest(cast_app_id, receivers[i]);
				launch_request.parameters = '';
				cast_api.launch(launch_request, on_launch);
			}
		};

		on_launch = function(activity) {
			if (activity.status == "running") {
				cv_activity = activity;
				// update UI to reflect that the receiver has received the
				// launch command and should start video playback.
				console.log("receiver has received launch command");
				window.setTimeout(function() {
					send_message_to_cc({'type': "message", 'body': 'ready'});
					}, 500);
				
			} else if (activity.status == "error") {
				cv_activity = null;
				console.log("receiver error on launch command");
			}

		};

		send_message_to_cc = function(msg){
			cast_api.sendMessage(
				cv_activity.activityId,
				"e2e",
				msg,
				on_msg_rcvd_by_cc
			);
		};

		on_msg_rcvd_by_cc = function(status_msg){

			if (status_msg){
				console.log(status_msg);
			}
		}

                function sendme(){

			var u = document.getElementById("url");
			u = u.value;
			send_message_to_cc({'type': 'url', 'body': u});
			return false;
		}

                function send_message(){

			var u = document.getElementById("msg");
			u = u.value;
			send_message_to_cc({'type': 'message', 'body': u});
			return false;
		}
	     
	</script>
</head>
<body>
	<h1>Sender</h1>
	<div id="ws_msg_rcpt_div"></div>

	<form>
	  <input type="text" id="url" value="" />
	  <button onclick="sendme(); return false;">SEND URL</button>
	</form>

	<form>
	  <input type="text" id="msg" value="" />
	  <button onclick="send_message(); return false;">SEND WORDS</button>
	</form>

</body>
<html>
